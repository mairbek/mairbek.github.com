---
name: Logging Gotcha
layout: default
title: Logging Gotcha
time: 2012-01-21 09:49:00 +02:00
---

<p>
Любое мало-мальски уважающее себя приложение не обходится без логгирования. Конечно, ведь иначе работа аппликухи в продакшне превращается в черный ящик.
</p>

<p>
Современные библиотеки позволяют сохранять информацию на различных уровнях логгирования. В проектах, в которых я участвовал, обычно используется четыре уровня логгирования:
</p>

<ul>
  <li><i>ERROR</i> -- сюда выводится информация о критичных ошибках в системе.</li>
  <li><i>WARN</i> -- используется для вывода не критичных, но все же некорректных сиптомов неправльной работы приложения</li>
  <li><i>INFO</i> -- используется для вывода интересных событий происходлящих в системе</li>
  <li><i>DEBUG</i> -- детальныая информация о том, что происходит с системой. обычно используется при разработке либо при отладке.</li>
</ul>
<p>Обычно запись в лог выглядит довольно просто:</p>


{% highlight java %}
log.error("SOMETHING REALLY BAD HAPPENED")
log.warn("Something bad happened")
log.info("Startup")
log.debug("Processing request" + request)
{% endhighlight %}

<p>
Уровни логгирования легко конфигурируются, так что мы можем наблюдать debug информацию при разработке и видеть чистый лог в продакшне.
</p>
<p>
До сих пор, строки кода в open source библиотеках вида:
</p>

{% highlight java %}
if (log.isDebugEnabled()) {
    log.debug("Processing request" + request);
}
{% endhighlight %}

<p>
вызывали недоумения: зачем это нужно, ведь запись в лог будет лишь при включенном дебаге, соответсвенно проверка влюченности дебага попахивает излишеством.
</p>

<p>
Однако, недавно я обнаружил, что подход без использования проверки влюченности уровня логгирования несет недостатки о которых мне раньше не приходилось задумываться.
</p>

<p>
Очень часто во время вывода в <i>debug</i> строки конкатенируются. И конкатенируются они независимо от того влючен дебаг или нет. Это во-первых приводит к тому, что создаются лишние строки что приводит к большим вызовам GC.
</p>

<p>
Во-вторых, операция <i>toString</i> может занимать продолжительное количество времени, и как показала недавняя история до 15% времени тормозящего метода.
</p>

<p>
Получается писать проверку влюченности уровня необходимо. Но не удобно. Количество строчек кода для записи в лог увеличивается в три раза.
</p>

<p>
Однако, если в проекте используется библиотека логирования <i>slf4j</i>, можно обойтись малой кровью используя шаблоны в строках. Как это работает:
</p>

<p>
Вместо конкатенации строк при логировании
</p>

{% highlight java %}
log.debug("Processed request " + request + " sending response " + response);
{% endhighlight %}
писать

{% highlight java %}
log.debug("Processed request {} sending response {}", request, response);
{% endhighlight %}

