--- 
name: zookeeper
layout: post
title: ZooKeeper Intro
time: 2011-05-11 19:00:00 +03:00
---
<div>Любое распределенное приложение не может обойтись без центрального сервиса, который координирует процессы в нем. Реализовывать координацию самому -- задача не из легких. Правильно реализовать fault tolerant координатор без deadlock'ов и race conditions, более нетривиально. Проект <i>Apache ZooKeeper</i> призван избавить нас от решения этой проблемы.</div><div><br /></div><div><i>ZooKeeper</i> -- это распределенный, open-source сервис координнации для расспределенных приложений. Он предоставляет низкоуровневый API, с помощью которого приложения могут реализовать высокоуровневые сервисы для координации и синхронизации узлов системы. </div><div><br /></div><div><i>ZooKeeper</i> реплицируется и обрабатывает команды в строгой последовательности. Первое намного повышает его надежность, второе дает возможность пользователям разрабатывать примитивы синхронизации для распределенных систем. Все данные <i>ZooKeeper</i> держит в памяти, что позволяет ему работать черезвычайно быстро. </div><div><br /></div><div>API <i>ZooKeeper'a</i> черезвычайно прост. Распределенные процессы могут координироваться между собой с помощью расшаренной на всех клиентов иерархии znode'ов, организация которых по структуре похожа на файловую систему. Как и в файловой системе каждый <i>znode</i> идентифицируется своим уникальным путем, вида <i>/node1/stuff/logs</i>. В отличии от привычной файловой системы, каждый <i>znode</i> может быть корневым узлом для других<i> znode'ов</i>. Если говорить в терминах файловой системы: файл может выступать в роли директории. <i>Znode'ы</i> версионируются и <i>ZooKeeper</i> позволяет "смотреть"(<i>watch</i>) за изменениями в ноде. Как только <i>znode'a</i> изменяется, клиент, смотрящий за нодой, получает пакет, который говорит что в ноде произошло измение.</div><div><br /></div><div><i>ZooKeeper</i> очень прост и при этом очень быстр. Он предназначен быть базой для более сложных сервисов, по-этому он разработчики дауют нам следующие гарантии:</div><div><ul><li><i>Sequential Consistency</i> - Обновления от клиента будут применены в порядке в котором они были отправены</li><li><i>Atomicity</i> - Изменения от клиента атомарны, они либо исполняются либо нет</li><li><i>Single System Image</i> - Клиент получет одинаковый набор znode'ов вне зависимости от того к какому серверу он подключен</li><li><i>Reliability</i> - Как только измение было применено, состояние будет неизменно до тех пор пока клиент не перетрет его</li><li><i>Timeliness</i> - Состояние системы для клиент гарантированно up-to-date с некоторой погрешностью по времени</li></ul></div><div>Рассмотрим простой пример использования <i>ZooKeeper</i>. Напишем приложение, которое распределенно выполняет некоторый набор задач, для простоты считает количество символов в строках и выдает по ним стастику, например общее число символов, минимальное/максимальное/среднее число символов в строке.</div><div><br /></div><div>Наше распределенное приложение будет состоять из следующих узлов:</div><div><br /></div><div><b>Мастер (Master) </b>-- рассылает задачи ядрам и делает отчет о выполнении работы</div><div><b>Ядра (Kernels) </b>-- которые считаю обрабатывают задачу</div><div><b>Координационный сервис</b> -- кластер <i>ZooKeepeer</i>, который обеспечивает координацию между ядрами.</div><div><br /></div><div>Скроем код координационного сервиса за следующим интерфейсом</div><div><br /></div><div><script src="https://gist.github.com/966737.js"> </script></div><div><br /></div><div>Координатор позволяет ядрам регистрироватся, а так же ставить задачу на выполнение. Задача выполняется асинхронно, плюс мы имеем callback вида</div><div><br /></div><div><b><script src="https://gist.github.com/966768.js"> </script></b></div><div><br /></div><div>Ядро в простейшем варианте умеет выполнять задачу и записывать результат:</div><div><br /></div><div><b><script src="https://gist.github.com/966769.js"> </script></b></div><div><br /></div><div>Мастер в свою очередь имеет всего лишь одим метод run:</div><div><br /></div><div><b><script src="https://gist.github.com/966774.js"> </script></b></div><div><br /></div><div>Здесь TaskProvider вычитывает задачи, а ResultCollector строит отчет. Их код приведен ниже:</div><div><br /></div><div><script src="https://gist.github.com/966777.js"> </script></div><div><b><br /></b></div><div><script src="https://gist.github.com/966779.js"> </script></div><div><br /></div><div>Рассмотрим реализацию сервера координации с помощью ZooKeeper. Используем следующую структуру znode'ов для распределения задач.</div><div><br /></div><div><script src="https://gist.github.com/971395.js"> </script></div><div><div><br /></div></div><div>Для каждого ядра n существует <i>znode</i> с названием <i>"/kernel"+kernelId</i>. Если ядро в данный момент свободно и не занимается обработкой задачи, то у него присутсвтует дочерний node <i>indicator</i>. При регистрации ядра так же создаются ноды <i>input</i> и <i>output</i>. <i>Znode'у</i> <i>/root/kernelN/input</i> присвоен <i>watcher</i>, при вызове которого, координатор считывает входные параметры задачи и передает ее в kernel на выполнение. По оканчнанию работы над задачей <i>kernel</i> записывает результат в ноду <i>/root/kernelN/output</i>, <i>watcher</i> которого оповещает <i>master'a</i> и востанавливает индикатор готовности к работы. Регистрация задачи на выполнение сводится к удалению индикатора готовности и записи в znode <i>/root/kernelN/input</i>.</div><div><br /></div><div>Инкапсулируем структуру<i> znode'ов kernel'a</i> в отдельный класс:</div><div><br /></div><div><script src="https://gist.github.com/971386.js"> </script></div><div><br /></div><div>Реализация сервиса координации выглядит следующим образом:</div><div><br /></div><div><script src="https://gist.github.com/971387.js"> </script></div><br />Посмотреть, что получилось в итоге можно на <a href="https://github.com/mairbek/zookeeper-simple">github'e</a><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/4802694757293965538-617668402206599003?l=khadikov.blogspot.com' alt='' /></div>
